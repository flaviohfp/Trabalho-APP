package hotel;

//------------Bibliotecas------------

import javafx.application.Application;
import javafx.geometry.HPos;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.scene.paint.Color;
import javafx.scene.text.Font;
import javafx.scene.text.FontWeight;
import javafx.stage.Stage;

import java.sql.*;
import java.time.LocalDate;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.List;

//-----Criação da Classe que estende aplication do JavaFx.


public class HotelApp extends Application {
    private Stage window;
    private int usuarioLogadoId = -1;
    private int reservaId = -1;
    private double valorQuartoSelecionado = 0.0;
    private double valorPratosSelecionados = 0.0;
    private String quartoSelecionado = "";
    private List<Integer> pratosSelecionadosIds = new ArrayList<>();
    private Label lblValorTotal = new Label("Valor Total: R$0.00");
    private Scene telaInicial, telaLogin, telaCadastro;

    public static void main(String[] args) {
        launch(args);
    }




    // -------------------- Conexão --------------------
    private Connection conectar() {
        try {
            return DriverManager.getConnection(
                    "jdbc:postgresql://localhost:5432/Hotel_db",
                    "postgres",
                    "root"
            );
        } catch (SQLException e) {
            Alert alert = new Alert(Alert.AlertType.ERROR, "Erro ao conectar ao banco! Verifique se o PostgreSQL está rodando.");
            estilizarAlerta(alert);
            alert.showAndWait();
            return null;
        }
    }



    // Estilizar alerts
    private void estilizarAlerta(Alert alert) {
        DialogPane dialogPane = alert.getDialogPane();
        dialogPane.setStyle("-fx-background-color: #e0f7fa; -fx-font-family: Arial; -fx-font-size: 14px;");
        dialogPane.lookupButton(ButtonType.OK).setStyle(
                "-fx-background-color: #00796b; -fx-text-fill: white; -fx-background-radius: 10;"
        );
    }

    @Override
    public void start(Stage primaryStage) {
        window = primaryStage;
        criarTelaLogin();
        criarTelaCadastro();
        criarTelaInicial();

        window.setScene(telaInicial);
        window.setTitle("EasyRoom - Hotel");
        window.setResizable(false);
        window.show();
        window.centerOnScreen();
    }





    // -------------------- Tela Inicial --------------------
    private void criarTelaInicial() {
        VBox layout = new VBox(20);
        layout.setAlignment(Pos.CENTER);
        layout.setPadding(new Insets(30));
        layout.setStyle("-fx-background-color: linear-gradient(to bottom, #b2ebf2, #e0f7fa);");

        Label titulo = new Label("EasyRoom Hotel");
        titulo.setFont(Font.font("Arial", FontWeight.BOLD, 32));
        titulo.setTextFill(Color.web("#00796b"));


// Botoes


 Button btnLogin = criarBotao("Login", "Acesse sua conta");
        Button btnReserva = criarBotao(possuiReserva(usuarioLogadoId) ? "Editar Reserva" : "Fazer Reserva", "Gerencie suas reservas");
        Button btnVerQuartos = criarBotao("Ver Quartos", "Explore nossos quartos");
        Button btnSair = criarBotao("Sair", "Fechar o aplicativo");

        VBox botoes = new VBox(15, btnLogin, btnReserva, btnVerQuartos, btnSair);
        botoes.setAlignment(Pos.CENTER);

        layout.getChildren().addAll(titulo, new Separator(), botoes);
        if (usuarioLogadoId == -1) {
            btnReserva.setVisible(false);
        }

        btnLogin.setOnAction(e -> window.setScene(telaLogin));
        btnReserva.setOnAction(e -> window.setScene(possuiReserva(usuarioLogadoId) ? telaEditarReserva() : telaReserva()));
        btnVerQuartos.setOnAction(e -> mostrarQuartos());
        btnSair.setOnAction(e -> window.close());

        telaInicial = new Scene(layout, 800, 600);
    }




 private Button criarBotao(String texto, String tooltip) {
        Button btn = new Button(texto);
        btn.setPrefWidth(250);
        btn.setStyle(
                "-fx-background-color: #00796b; -fx-text-fill: white; -fx-font-size: 16; " +
                        "-fx-background-radius: 15; -fx-padding: 10; -fx-font-family: Arial; " +
                        "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 5, 0, 0, 2);"
        );
        btn.setOnMouseEntered(e -> btn.setStyle(
                "-fx-background-color: #004d40; -fx-text-fill: white; -fx-font-size: 16; " +
                        "-fx-background-radius: 15; -fx-padding: 10; -fx-font-family: Arial; " +
                        "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.5), 8, 0, 0, 3);"
        ));
        btn.setOnMouseExited(e -> btn.setStyle(
                "-fx-background-color: #00796b; -fx-text-fill: white; -fx-font-size: 16; " +
                        "-fx-background-radius: 15; -fx-padding: 10; -fx-font-family: Arial; " +
                        "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.3), 5, 0, 0, 2);"
        ));
        if (tooltip != null) {
            btn.setTooltip(new Tooltip(tooltip));
        }
        return btn;
    }



private boolean possuiReserva(int usuarioId) {
        if (usuarioId == -1) return false;
        try (Connection con = conectar()) {
            PreparedStatement stmt = con.prepareStatement("SELECT COUNT(*) FROM reservas WHERE usuario_id = ?");
            stmt.setInt(1, usuarioId);
            ResultSet rs = stmt.executeQuery();
            return rs.next() && rs.getInt(1) > 0;
        } catch (SQLException e) {
            return false;
        }
    }

    private void atualizarTelaInicial() {
        criarTelaInicial();
        window.setScene(telaInicial);
    }



    
    // -------------------- Tela Login --------------------
    private void criarTelaLogin() {
        GridPane layout = criarGrid();
        Label titulo = new Label("Login");
        titulo.setFont(Font.font("Arial", FontWeight.BOLD, 24));
        titulo.setTextFill(Color.web("#00796b"));
        layout.add(titulo, 0, 0, 2, 1);
        GridPane.setHalignment(titulo, HPos.CENTER);

        TextField txtEmail = criarCampo(layout, "Email:", 1);
        PasswordField txtSenha = (PasswordField) criarCampo(layout, "Senha:", 2, true);
        Button btnEntrar = criarBotao("Entrar", "Acesse sua conta");
        Button btnIrCadastro = criarBotao("Criar Conta", "Registre-se no sistema");
        Button btnVoltar = criarBotao("Voltar", "Retornar à tela inicial");
        Button btnSair = criarBotao("Sair", "Fechar o aplicativo");



 HBox botoes = new HBox(15, btnVoltar, btnEntrar, btnIrCadastro, btnSair);
        botoes.setAlignment(Pos.CENTER);
        layout.add(botoes, 0, 3, 2, 1);

        btnEntrar.setOnAction(e -> login(txtEmail.getText(), txtSenha.getText()));
        btnIrCadastro.setOnAction(e -> window.setScene(telaCadastro));
        btnVoltar.setOnAction(e -> window.setScene(telaInicial));
        btnSair.setOnAction(e -> window.close());

        telaLogin = new Scene(layout, 800, 600);
    }



private void login(String email, String senha) {
        if (email.isEmpty() || senha.isEmpty()) {
            Alert alert = new Alert(Alert.AlertType.ERROR, "Preencha todos os campos!");
            estilizarAlerta(alert);
            alert.showAndWait();
            return;
        }
        try (Connection con = conectar()) {
            PreparedStatement stmt = con.prepareStatement("SELECT * FROM usuarios WHERE email=? AND senha=?");
            stmt.setString(1, email);
            stmt.setString(2, senha);
            ResultSet rs = stmt.executeQuery();
            if (rs.next()) {
                usuarioLogadoId = rs.getInt("id");
                Alert alert = new Alert(Alert.AlertType.INFORMATION, "Login realizado com sucesso!");
                estilizarAlerta(alert);
                alert.showAndWait();
                atualizarTelaInicial();
            } else {
                Alert alert = new Alert(Alert.AlertType.ERROR, "Email ou senha incorretos!");
                estilizarAlerta(alert);
                alert.showAndWait();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }



    // -------------------- Tela Cadastro --------------------
    private void criarTelaCadastro() {
        GridPane layout = criarGrid();
        Label titulo = new Label("Cadastro");
        titulo.setFont(Font.font("Arial", FontWeight.BOLD, 24));
        titulo.setTextFill(Color.web("#00796b"));
        layout.add(titulo, 0, 0, 2, 1);
        GridPane.setHalignment(titulo, HPos.CENTER);

        TextField txtNome = criarCampo(layout, "Nome:", 1);
        TextField txtTelefone = criarCampo(layout, "Telefone:", 2);
        TextField txtEmail = criarCampo(layout, "Email:", 3);
        PasswordField txtSenha = (PasswordField) criarCampo(layout, "Senha:", 4, true);
        Button btnCadastrar = criarBotao("Cadastrar", "Registre-se no sistema");
        Button btnVoltar = criarBotao("Voltar", "Retornar à tela inicial");
        Button btnSair = criarBotao("Sair", "Fechar o aplicativo");

        HBox botoes = new HBox(15, btnVoltar, btnCadastrar, btnSair);
        botoes.setAlignment(Pos.CENTER);
        layout.add(botoes, 0, 5, 2, 1);

        btnCadastrar.setOnAction(e -> cadastrar(txtNome.getText(), txtTelefone.getText(), txtEmail.getText(), txtSenha.getText()));
        btnVoltar.setOnAction(e -> window.setScene(telaInicial));
        btnSair.setOnAction(e -> window.close());

        telaCadastro = new Scene(layout, 800, 600);
    }


    private void cadastrar(String nome, String telefone, String email, String senha) {
        if (nome.isEmpty() || email.isEmpty() || senha.isEmpty()) {
            Alert alert = new Alert(Alert.AlertType.ERROR, "Preencha todos os campos!");
            estilizarAlerta(alert);
            alert.showAndWait();
            return;
        }
        try (Connection con = conectar()) {
            PreparedStatement stmt = con.prepareStatement("INSERT INTO usuarios (nome, telefone, email, senha) VALUES (?,?,?,?) RETURNING id");
            stmt.setString(1, nome);
            stmt.setString(2, telefone);
            stmt.setString(3, email);
            stmt.setString(4, senha);
            ResultSet rs = stmt.executeQuery();
            if (rs.next()) {
                usuarioLogadoId = rs.getInt("id");
                Alert alert = new Alert(Alert.AlertType.INFORMATION, "Cadastro realizado com sucesso!");
                estilizarAlerta(alert);
                alert.showAndWait();
                atualizarTelaInicial();
            }
        } catch (SQLException e) {
            Alert alert = new Alert(Alert.AlertType.ERROR, "Erro ao cadastrar! Verifique se o email já está em uso.");
            estilizarAlerta(alert);
            alert.showAndWait();
        }
    }

    private GridPane criarGrid() {
        GridPane g = new GridPane();
        g.setHgap(15);
        g.setVgap(15);
        g.setAlignment(Pos.CENTER);
        g.setPadding(new Insets(30));
        g.setStyle("-fx-background-color: #e0f7fa; -fx-font-family: Arial;");
        return g;
    }

    private TextField criarCampo(GridPane layout, String texto, int linha) {
        return (TextField) criarCampo(layout, texto, linha, false);
    }

    private TextField criarCampo(GridPane layout, String texto, int linha, boolean senha) {
        Label lbl = new Label(texto);
        lbl.setFont(Font.font("Arial", FontWeight.BOLD, 14));
        lbl.setTextFill(Color.web("#004d40"));
        TextField campo = senha ? new PasswordField() : new TextField();
        campo.setPrefWidth(300);
        campo.setStyle("-fx-background-color: #ffffff; -fx-border-color: #00796b; -fx-border-radius: 5; -fx-font-family: Arial;");
        layout.add(lbl, 0, linha);
        layout.add(campo, 1, linha);
        return campo;
    }
